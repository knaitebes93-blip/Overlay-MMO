name: PR Windows Build

on:
  pull_request:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~\.cargo\registry
            ~\.cargo\git
            src-tauri\target
          key: ${{ runner.os }}-cargo-${{ hashFiles('src-tauri/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install dependencies
        shell: pwsh
        run: |
          if (Test-Path "package-lock.json") {
            npm ci
            if ($LASTEXITCODE -ne 0) {
              Write-Warning "npm ci failed (lockfile out of sync). Falling back to npm install."
              npm install
              if ($LASTEXITCODE -ne 0) { throw "npm install failed" }
            }
          }
          else {
            npm install
            if ($LASTEXITCODE -ne 0) { throw "npm install failed" }
          }

      - name: Build Tauri app
        run: |
          npm run build
          npm run tauri build -- --bundles nsis

      - name: List Tauri build outputs
        shell: pwsh
        run: |
          Get-ChildItem -Recurse -Force "src-tauri\target\release\bundle" | Select-Object FullName

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Overlay-MMO-windows
          path: |
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/overlay-mmo.exe
          if-no-files-found: error
